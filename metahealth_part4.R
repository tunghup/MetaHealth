# metahealth_part4_complete.r - Logic x·ª≠ l√Ω ph√¢n t√≠ch g·ªôp MA

# H√†m module cho ph√¢n t√≠ch g·ªôp (MA)
ma_server_module <- function(input, output, session) {
  # --------- MA DATA HANDLING ---------
  # Initialize with sample data
  ma_data <- reactiveVal(get_ma_sample("Contrast-based", "Bi·∫øn li√™n t·ª•c"))
  
  # Update instructions based on selected data type
  output$ma_instr <- renderUI({
    key <- paste(input$ma_type, input$ma_outcome, sep=" - ")
    HTML(ma_instructions[[key]])
  })
  
  # Switch between sample and manual data when radio button changes
  observeEvent(input$ma_data_mode, {
    if (input$ma_data_mode == "sample") {
      ma_data(get_ma_sample(input$ma_type, input$ma_outcome))
    }
    # For manual data, we'll wait for the user to click "T·∫°o b·∫£ng nh·∫≠p li·ªáu" button
  })
  
  # Update sample data when type or outcome changes (only in sample mode)
  observeEvent(c(input$ma_type, input$ma_outcome), {
    if (input$ma_data_mode == "sample") {
      ma_data(get_ma_sample(input$ma_type, input$ma_outcome))
    }
  })
  
  # Generate table for manual input when button is clicked
  observeEvent(input$ma_generate_table, {
    req(input$ma_study_count)
    n_studies <- input$ma_study_count
    
    # Create empty table with specified number of rows
    df <- create_ma_empty_data(input$ma_type, input$ma_outcome, n_studies)
    ma_data(df)
  })
  
  # Render the data table using rHandsontable
  output$ma_datatable <- renderRHandsontable({
    rhandsontable(ma_data(), stretchH = "all", height = 300) %>%
      hot_table(highlightRow = TRUE, highlightCol = TRUE) %>%
      hot_context_menu(allowRowEdit = TRUE, allowColEdit = FALSE)
  })
  
  # Get updated data from the handsontable
  observe({
    if(!is.null(input$ma_datatable)){
      ma_data(hot_to_r(input$ma_datatable))
    }
  })
  
  # --------- MA ANALYSIS ---------
  meta_result <- eventReactive(input$ma_run, {
    updateTabItems(session, "sidebar", "ma_results")
    
    df <- ma_data()
    
    # Remove rows with NA values in essential columns (but keep RegVar even if NA)
    if(input$ma_type == "Contrast-based" && input$ma_outcome == "Bi·∫øn li√™n t·ª•c") {
      df <- df[!is.na(df$Study) & !is.na(df$ES) & !is.na(df$ll) & !is.na(df$ul), ]
    } else if(input$ma_type == "Contrast-based" && input$ma_outcome == "Bi·∫øn ph√¢n lo·∫°i") {
      df <- df[!is.na(df$Study) & !is.na(df$ES) & !is.na(df$ll) & !is.na(df$ul), ]
    } else if(input$ma_type == "Arm-based" && input$ma_outcome == "Bi·∫øn li√™n t·ª•c") {
      df <- df[!is.na(df$Study) & !is.na(df$Exp_N) & !is.na(df$Exp_Mean) & !is.na(df$Exp_SD) &
                 !is.na(df$Ctrl_N) & !is.na(df$Ctrl_Mean) & !is.na(df$Ctrl_SD), ]
    } else { # Arm-based & Bi·∫øn ph√¢n lo·∫°i
      df <- df[!is.na(df$Study) & !is.na(df$Exp_Event) & !is.na(df$Exp_N) & 
                 !is.na(df$Ctrl_Event) & !is.na(df$Ctrl_N), ]
    }
    
    if (nrow(df) < 3) {
      return(structure(list(error="C·∫ßn √≠t nh·∫•t 3 d√≤ng d·ªØ li·ªáu ƒë·∫ßy ƒë·ªß!"), class="error"))
    }
    
    if (input$ma_type == "Contrast-based" && input$ma_outcome == "Bi·∫øn li√™n t·ª•c") {
      # Calculate seTE from ll and ul
      df$TE <- df$ES
      df$seTE <- (df$ul - df$ll) / (2 * 1.96)
      
      tryCatch(
        meta::metagen(
          TE, seTE, 
          data = df, 
          studlab = Study, 
          sm = "SMD",
          common = (input$ma_model == "T√°c ƒë·ªông c·ªë ƒë·ªãnh (fixed-effects)"),
          random = (input$ma_model == "T√°c ƒë·ªông ng·∫´u nhi√™n (random-effects)")
        ),
        error = function(e) structure(list(error = e$message), class = "error")
      )
    } else if (input$ma_type == "Contrast-based" && input$ma_outcome == "Bi·∫øn ph√¢n lo·∫°i") {
      # Calculate seTE from ll and ul
      df$TE <- df$ES
      df$seTE <- (df$ul - df$ll) / (2 * 1.96)
      
      tryCatch(
        meta::metagen(
          TE, seTE, 
          data = df, 
          studlab = Study, 
          sm = "OR",
          common = (input$ma_model == "T√°c ƒë·ªông c·ªë ƒë·ªãnh (fixed-effects)"),
          random = (input$ma_model == "T√°c ƒë·ªông ng·∫´u nhi√™n (random-effects)")
        ),
        error = function(e) structure(list(error = e$message), class = "error")
      )
    } else if (input$ma_type == "Arm-based" && input$ma_outcome == "Bi·∫øn li√™n t·ª•c") {
      tryCatch(
        meta::metacont(
          Exp_N, Exp_Mean, Exp_SD, 
          Ctrl_N, Ctrl_Mean, Ctrl_SD,
          data = df, 
          studlab = Study, 
          sm = "SMD",
          common = (input$ma_model == "T√°c ƒë·ªông c·ªë ƒë·ªãnh (fixed-effects)"),
          random = (input$ma_model == "T√°c ƒë·ªông ng·∫´u nhi√™n (random-effects)")
        ),
        error = function(e) structure(list(error = e$message), class = "error")
      )
    } else {
      tryCatch(
        meta::metabin(
          Exp_Event, Exp_N, 
          Ctrl_Event, Ctrl_N, 
          data = df, 
          studlab = Study, 
          sm = "OR",
          common = (input$ma_model == "T√°c ƒë·ªông c·ªë ƒë·ªãnh (fixed-effects)"),
          random = (input$ma_model == "T√°c ƒë·ªông ng·∫´u nhi√™n (random-effects)")
        ),
        error = function(e) structure(list(error = e$message), class = "error")
      )
    }
  })
  
  # Helper function to generate interpretation of meta-analysis results
  generate_ma_interpretation <- function(res) {
    # Check if result is valid
    if (inherits(res, "error")) {
      return("<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫°o bi·ªán gi·∫£i do l·ªói ph√¢n t√≠ch.</div>")
    }
    
    # Extract key statistics
    effect_measure <- res$sm
    effect_type <- if(effect_measure == "SMD") "bi·∫øn li√™n t·ª•c" else "bi·∫øn ph√¢n lo·∫°i"
    effect_size <- res$TE.random
    effect_lower <- res$lower.random
    effect_upper <- res$upper.random
    p_value <- res$pval.random
    i_squared <- res$I2 * 100
    q_p_value <- res$pval.Q
    n_studies <- length(res$TE)
    
    # L·∫•y ƒë√∫ng lo·∫°i m√¥ h√¨nh ƒëang ƒë∆∞·ª£c s·ª≠ d·ª•ng
    model <- ifelse(input$ma_model == "T√°c ƒë·ªông ng·∫´u nhi√™n (random-effects)", 
                    "t√°c ƒë·ªông ng·∫´u nhi√™n", "t√°c ƒë·ªông c·ªë ƒë·ªãnh")
    
    # Create interpretation
    html_content <- paste0(
      "<div style='margin-top: 20px; padding: 10px; background-color: #e6f7ff; border-left: 4px solid #1890ff;'>",
      "<h4 style='color: #1890ff;'>üîç Bi·ªán gi·∫£i k·∫øt qu·∫£ cho d·ªØ li·ªáu hi·ªán t·∫°i:</h4>"
    )
    
    # Number of studies
    html_content <- paste0(html_content,
                           "<p>Ph√¢n t√≠ch g·ªôp bao g·ªìm <b>", n_studies, " nghi√™n c·ª©u</b> v·ªõi m√¥ h√¨nh <b>", model, "</b>.</p>"
    )
    
    # Effect size interpretation
    if (effect_measure == "SMD") {
      effect_strength <- ifelse(abs(effect_size) < 0.2, "kh√¥ng ƒë√°ng k·ªÉ",
                                ifelse(abs(effect_size) < 0.5, "nh·ªè",
                                       ifelse(abs(effect_size) < 0.8, "trung b√¨nh", "l·ªõn")))
      
      effect_direction <- ifelse(effect_size > 0, "thu·∫≠n l·ª£i cho nh√≥m can thi·ªáp", "thu·∫≠n l·ª£i cho nh√≥m ch·ª©ng")
      
      html_content <- paste0(html_content,
                             "<p><b>M·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng g·ªôp:</b> SMD = ", round(effect_size, 2), 
                             " (95% CI: ", round(effect_lower, 2), " ƒë·∫øn ", round(effect_upper, 2), "), ",
                             "cho th·∫•y m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng <b>", effect_strength, "</b> v√† ", 
                             ifelse(p_value < 0.05, 
                                    paste0("<b>c√≥ √Ω nghƒ©a th·ªëng k√™</b> (p = ", format(p_value, digits=3), "), "), 
                                    paste0("<b>kh√¥ng c√≥ √Ω nghƒ©a th·ªëng k√™</b> (p = ", format(p_value, digits=3), "), ")),
                             "h∆∞·ªõng ", effect_direction, ".</p>"
      )
    } else {
      # For OR interpretation
      or_value <- exp(effect_size)
      or_lower <- exp(effect_lower)
      or_upper <- exp(effect_upper)
      
      effect_direction <- ifelse(or_value > 1, "tƒÉng", "gi·∫£m")
      
      html_content <- paste0(html_content,
                             "<p><b>M·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng g·ªôp:</b> OR = ", round(or_value, 2), 
                             " (95% CI: ", round(or_lower, 2), " ƒë·∫øn ", round(or_upper, 2), "), ",
                             "cho th·∫•y nh√≥m can thi·ªáp c√≥ nguy c∆° <b>", effect_direction, "</b> ",
                             abs(round((or_value - 1) * 100, 1)), "% so v·ªõi nh√≥m ch·ª©ng v√† k·∫øt qu·∫£ n√†y ",
                             ifelse(p_value < 0.05, 
                                    "<b>c√≥ √Ω nghƒ©a th·ªëng k√™</b>", 
                                    "<b>kh√¥ng c√≥ √Ω nghƒ©a th·ªëng k√™</b>"),
                             " (p = ", format(p_value, digits=3), ").</p>"
      )
    }
    
    # Heterogeneity interpretation
    het_level <- ifelse(i_squared < 25, "th·∫•p",
                        ifelse(i_squared < 50, "trung b√¨nh",
                               ifelse(i_squared < 75, "ƒë√°ng k·ªÉ", "cao")))
    
    html_content <- paste0(html_content,
                           "<p><b>T√≠nh b·∫•t ƒë·ªìng nh·∫•t:</b> I¬≤ = ", round(i_squared, 1), "%, cho th·∫•y m·ª©c ƒë·ªô b·∫•t ƒë·ªìng nh·∫•t <b>", het_level, "</b> ",
                           "gi·ªØa c√°c nghi√™n c·ª©u. Ki·ªÉm ƒë·ªãnh Q cho th·∫•y s·ª± b·∫•t ƒë·ªìng nh·∫•t ",
                           ifelse(q_p_value < 0.1, 
                                  paste0("<b>c√≥ √Ω nghƒ©a th·ªëng k√™</b> (p = ", format(q_p_value, digits=3), ")."),
                                  paste0("<b>kh√¥ng c√≥ √Ω nghƒ©a th·ªëng k√™</b> (p = ", format(q_p_value, digits=3), ").")),
                           "</p>"
    )
    
    # Model recommendation
    html_content <- paste0(html_content,
                           "<p><b>G·ª£i √Ω:</b> ", 
                           ifelse(i_squared > 50 || q_p_value < 0.1,
                                  "V·ªõi m·ª©c ƒë·ªô b·∫•t ƒë·ªìng nh·∫•t ƒë√°ng k·ªÉ, n√™n s·ª≠ d·ª•ng m√¥ h√¨nh <b>t√°c ƒë·ªông ng·∫´u nhi√™n</b>.",
                                  "V·ªõi m·ª©c ƒë·ªô b·∫•t ƒë·ªìng nh·∫•t th·∫•p, c√≥ th·ªÉ xem x√©t s·ª≠ d·ª•ng m√¥ h√¨nh <b>t√°c ƒë·ªông c·ªë ƒë·ªãnh</b>, nh∆∞ng m√¥ h√¨nh t√°c ƒë·ªông ng·∫´u nhi√™n v·∫´n th∆∞·ªùng ƒë∆∞·ª£c ∆∞a chu·ªông h∆°n trong c√°c nghi√™n c·ª©u y h·ªçc."),
                           "</p></div>"
    )
    
    return(html_content)
  }
  
  # Generate forest plot interpretation
  generate_forest_interpretation <- function(res) {
    if (inherits(res, "error")) {
      return("<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫°o bi·ªán gi·∫£i do l·ªói ph√¢n t√≠ch.</div>")
    }
    
    # Extract information from results
    n_studies <- length(res$TE)
    n_significant <- sum((res$lower > 0 & res$TE > 0) | (res$upper < 0 & res$TE < 0))
    effect_size <- res$TE.random
    effect_lower <- res$lower.random
    effect_upper <- res$upper.random
    p_value <- res$pval.random
    i_squared <- res$I2 * 100
    
    # Create interpretation
    html_content <- paste0(
      "<div style='margin-top: 20px; padding: 10px; background-color: #e6f7ff; border-left: 4px solid #1890ff;'>",
      "<h4 style='color: #1890ff;'>üîç Bi·ªán gi·∫£i bi·ªÉu ƒë·ªì r·ª´ng cho d·ªØ li·ªáu hi·ªán t·∫°i:</h4>"
    )
    
    # Distribution of studies
    html_content <- paste0(html_content,
                           "<p>Bi·ªÉu ƒë·ªì r·ª´ng tr√¨nh b√†y k·∫øt qu·∫£ t·ª´ ", n_studies, " nghi√™n c·ª©u ƒë·ªôc l·∫≠p. ",
                           "C√≥ ", n_significant, " nghi√™n c·ª©u (", round(n_significant/n_studies*100), "%) ",
                           "cho th·∫•y k·∫øt qu·∫£ c√≥ √Ω nghƒ©a th·ªëng k√™ (kho·∫£ng tin c·∫≠y 95% kh√¥ng c·∫Øt qua ƒë∆∞·ªùng kh√¥ng hi·ªáu ·ª©ng).</p>"
    )
    
    # Overall effect interpretation
    sig_overall <- (effect_lower > 0 && effect_size > 0) || (effect_upper < 0 && effect_size < 0)
    html_content <- paste0(html_content,
                           "<p><b>M·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng g·ªôp (h√¨nh thoi ‚ô¶):</b> M·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng g·ªôp ",
                           ifelse(sig_overall, 
                                  "c√≥ √Ω nghƒ©a th·ªëng k√™ v√¨ kho·∫£ng tin c·∫≠y 95% kh√¥ng c·∫Øt qua ƒë∆∞·ªùng kh√¥ng hi·ªáu ·ª©ng", 
                                  "kh√¥ng c√≥ √Ω nghƒ©a th·ªëng k√™ v√¨ kho·∫£ng tin c·∫≠y 95% c·∫Øt qua ƒë∆∞·ªùng kh√¥ng hi·ªáu ·ª©ng"),
                           ".</p>"
    )
    
    # Variation in studies
    html_content <- paste0(html_content,
                           "<p><b>Bi·∫øn thi√™n gi·ªØa c√°c nghi√™n c·ª©u:</b> Bi·ªÉu ƒë·ªì cho th·∫•y ",
                           ifelse(i_squared < 25, "s·ª± ƒë·ªìng nh·∫•t cao gi·ªØa c√°c nghi√™n c·ª©u", 
                                  ifelse(i_squared < 50, "s·ª± bi·∫øn thi√™n trung b√¨nh gi·ªØa c√°c nghi√™n c·ª©u", 
                                         "s·ª± bi·∫øn thi√™n l·ªõn gi·ªØa c√°c nghi√™n c·ª©u")),
                           ", v·ªõi I¬≤ = ", round(i_squared, 1), "%.</p>"
    )
    
    # Weights interpretation
    html_content <- paste0(html_content,
                           "<p><b>Tr·ªçng s·ªë nghi√™n c·ª©u:</b> K√≠ch th∆∞·ªõc c·ªßa c√°c h√¨nh vu√¥ng/h√¨nh tr√≤n th·ªÉ hi·ªán tr·ªçng s·ªë c·ªßa t·ª´ng nghi√™n c·ª©u. ",
                           "Nghi√™n c·ª©u c√≥ c·ª° m·∫´u l·ªõn h∆°n v√†/ho·∫∑c ƒë·ªô bi·∫øn thi√™n nh·ªè h∆°n s·∫Ω c√≥ tr·ªçng s·ªë l·ªõn h∆°n v√† t√°c ƒë·ªông nhi·ªÅu h∆°n ƒë·∫øn k·∫øt qu·∫£ t·ªïng h·ª£p.</p>"
    )
    
    # Recommendation
    html_content <- paste0(html_content,
                           "<p><b>K·∫øt lu·∫≠n:</b> D·ª±a tr√™n bi·ªÉu ƒë·ªì r·ª´ng, c√≥ th·ªÉ k·∫øt lu·∫≠n r·∫±ng m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng g·ªôp ",
                           ifelse(sig_overall, "ƒë√°ng tin c·∫≠y", "c·∫ßn ƒë∆∞·ª£c di·ªÖn gi·∫£i th·∫≠n tr·ªçng"),
                           " v·ªõi m·ª©c ƒë·ªô b·∫•t ƒë·ªìng nh·∫•t ", 
                           ifelse(i_squared < 50, "ch·∫•p nh·∫≠n ƒë∆∞·ª£c.", "ƒë√°ng k·ªÉ, c√≥ th·ªÉ c·∫ßn th√™m ph√¢n t√≠ch g·ªôp h·ªìi quy ƒë·ªÉ x√°c ƒë·ªãnh ngu·ªìn g·ªëc c·ªßa s·ª± b·∫•t ƒë·ªìng nh·∫•t."),
                           "</p></div>"
    )
    
    return(html_content)
  }
  
  # Generate publication bias interpretation
  generate_bias_interpretation <- function(res, egger_res) {
    if (inherits(res, "error")) {
      return("<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫°o bi·ªán gi·∫£i do l·ªói ph√¢n t√≠ch.</div>")
    }
    
    # Extract information
    n_studies <- length(res$TE)
    egger_p <- NA
    egger_intercept <- NA
    
    if (!is.null(egger_res) && !inherits(egger_res, "error")) {
      if ("p.value" %in% names(egger_res)) {
        egger_p <- egger_res$p.value
      }
      if ("estimate" %in% names(egger_res)) {
        egger_intercept <- egger_res$estimate[1]
      }
    }
    
    # Interpret funnel plot based on visual examination and Egger's test
    html_content <- paste0(
      "<div style='margin-top: 20px; padding: 10px; background-color: #e6f7ff; border-left: 4px solid #1890ff;'>",
      "<h4 style='color: #1890ff;'>üîç Bi·ªán gi·∫£i sai l·ªách xu·∫•t b·∫£n cho d·ªØ li·ªáu hi·ªán t·∫°i:</h4>"
    )
    
    # Number of studies interpretation
    html_content <- paste0(html_content,
                           "<p>Ph√¢n t√≠ch sai l·ªách xu·∫•t b·∫£n d·ª±a tr√™n ", n_studies, " nghi√™n c·ª©u. ",
                           ifelse(n_studies < 10, 
                                  "<b>L∆∞u √Ω quan tr·ªçng:</b> S·ªë l∆∞·ª£ng nghi√™n c·ª©u nh·ªè h∆°n 10 c√≥ th·ªÉ l√†m gi·∫£m ƒë·ªô tin c·∫≠y c·ªßa c√°c ph∆∞∆°ng ph√°p ƒë√°nh gi√° sai l·ªách xu·∫•t b·∫£n.",
                                  ""),
                           "</p>"
    )
    
    # Egger's test interpretation
    if (!is.na(egger_p)) {
      html_content <- paste0(html_content,
                             "<p><b>Ki·ªÉm ƒë·ªãnh Egger:</b> ",
                             ifelse(egger_p < 0.05,
                                    paste0("K·∫øt qu·∫£ c√≥ √Ω nghƒ©a th·ªëng k√™ (p = ", format(egger_p, digits=3), "), cho th·∫•y c√≥ b·∫±ng ch·ª©ng v·ªÅ sai l·ªách xu·∫•t b·∫£n."),
                                    paste0("K·∫øt qu·∫£ kh√¥ng c√≥ √Ω nghƒ©a th·ªëng k√™ (p = ", format(egger_p, digits=3), "), kh√¥ng ph√°t hi·ªán b·∫±ng ch·ª©ng r√µ r√†ng v·ªÅ sai l·ªách xu·∫•t b·∫£n.")),
                             "</p>"
      )
      
      if (!is.na(egger_intercept)) {
        bias_direction <- ifelse(egger_intercept > 0, "thi·∫øu c√°c nghi√™n c·ª©u c√≥ k·∫øt qu·∫£ √¢m t√≠nh", "thi·∫øu c√°c nghi√™n c·ª©u c√≥ k·∫øt qu·∫£ d∆∞∆°ng t√≠nh")
        html_content <- paste0(html_content,
                               "<p>H·ªá s·ªë ch·∫∑n (intercept) c·ªßa Egger = ", round(egger_intercept, 2),
                               ", g·ª£i √Ω kh·∫£ nƒÉng ", bias_direction, ".</p>"
        )
      }
    } else {
      html_content <- paste0(html_content,
                             "<p><b>Ki·ªÉm ƒë·ªãnh Egger:</b> Kh√¥ng th·ªÉ th·ª±c hi·ªán ki·ªÉm ƒë·ªãnh Egger do s·ªë l∆∞·ª£ng nghi√™n c·ª©u √≠t ho·∫∑c d·ªØ li·ªáu kh√¥ng ph√π h·ª£p.</p>"
      )
    }
    
    # Trim-and-fill interpretation
    html_content <- paste0(html_content,
                           "<p><b>Ph∆∞∆°ng ph√°p trim-and-fill:</b> Ph∆∞∆°ng ph√°p n√†y ∆∞·ªõc t√≠nh c√°c nghi√™n c·ª©u c√≥ th·ªÉ b·ªã thi·∫øu (hi·ªÉn th·ªã b·∫±ng c√°c ƒëi·ªÉm r·ªóng tr√™n bi·ªÉu ƒë·ªì). ",
                           "N·∫øu m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng g·ªôp thay ƒë·ªïi ƒë√°ng k·ªÉ sau khi th√™m c√°c nghi√™n c·ª©u ∆∞·ªõc t√≠nh, k·∫øt qu·∫£ ph√¢n t√≠ch g·ªôp c√≥ th·ªÉ b·ªã ·∫£nh h∆∞·ªüng b·ªüi sai l·ªách xu·∫•t b·∫£n.</p>"
    )
    
    # Overall assessment
    html_content <- paste0(html_content,
                           "<p><b>ƒê√°nh gi√° t·ªïng th·ªÉ:</b> ",
                           ifelse(is.na(egger_p) || n_studies < 10,
                                  "C·∫ßn th·∫≠n tr·ªçng khi di·ªÖn gi·∫£i k·∫øt qu·∫£ do s·ªë l∆∞·ª£ng nghi√™n c·ª©u h·∫°n ch·∫ø.",
                                  ifelse(egger_p < 0.05,
                                         "C√≥ b·∫±ng ch·ª©ng v·ªÅ sai l·ªách xu·∫•t b·∫£n, ƒëi·ªÅu n√†y c√≥ th·ªÉ ·∫£nh h∆∞·ªüng ƒë·∫øn t√≠nh gi√° tr·ªã c·ªßa k·∫øt qu·∫£ ph√¢n t√≠ch g·ªôp.",
                                         "Kh√¥ng c√≥ b·∫±ng ch·ª©ng m·∫°nh m·∫Ω v·ªÅ sai l·ªách xu·∫•t b·∫£n, tƒÉng ƒë·ªô tin c·∫≠y c·ªßa k·∫øt qu·∫£ ph√¢n t√≠ch g·ªôp.")),
                           "</p></div>"
    )
    
    return(html_content)
  }
  
  # Generate meta-regression interpretation
  generate_metareg_interpretation <- function(mr_result) {
    # Ki·ªÉm tra xem k·∫øt qu·∫£ c√≥ h·ª£p l·ªá kh√¥ng
    if (is.null(mr_result) || inherits(mr_result, "try-error") || !inherits(mr_result, "rma")) {
      return("<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫°o bi·ªán gi·∫£i do l·ªói ph√¢n t√≠ch.</div>")
    }
    
    # Tr√≠ch xu·∫•t th√¥ng tin c∆° b·∫£n v√† x·ª≠ l√Ω c√°c gi√° tr·ªã NA ho·∫∑c NULL
    mod_name <- ifelse(is.null(mr_result$formula), "RegVar", names(mr_result$beta)[2])
    mod_coef <- tryCatch(mr_result$beta[2], error = function(e) NA)
    mod_p <- tryCatch(mr_result$pval[2], error = function(e) NA)
    mod_ci_lower <- tryCatch(mr_result$ci.lb[2], error = function(e) NA)
    mod_ci_upper <- tryCatch(mr_result$ci.ub[2], error = function(e) NA)
    r2_value <- tryCatch(mr_result$R2, error = function(e) 0)
    if (is.null(r2_value) || is.na(r2_value)) r2_value <- 0
    
    i2_before <- NA
    i2_after <- NA
    
    # T√≠nh t·ª∑ l·ªá gi·∫£m b·∫•t ƒë·ªìng nh·∫•t
    tryCatch({
      i2_before <- mr_result$I2
      i2_after <- ifelse(is.null(mr_result$I2.resid), NA, mr_result$I2.resid)
      if (is.na(i2_after)) i2_after <- i2_before  # N·∫øu kh√¥ng c√≥ I2 residual, d√πng I2 ban ƒë·∫ßu
    }, error = function(e) {
      i2_before <- NA
      i2_after <- NA
    })
    
    # T·∫°o n·ªôi dung HTML bi·ªán gi·∫£i
    html_content <- paste0(
      "<div style='margin-top: 20px; padding: 15px; background-color: #f8f9fa; border-left: 4px solid #28a745;'>",
      "<h4 style='color: #28a745;'>üîç Bi·ªán gi·∫£i k·∫øt qu·∫£ ph√¢n t√≠ch g·ªôp h·ªìi quy:</h4>"
    )
    
    # Th√¥ng tin v·ªÅ bi·∫øn ƒëi·ªÅu ch·ªânh v√† h∆∞·ªõng t√°c ƒë·ªông
    if (!is.na(mod_coef)) {
      html_content <- paste0(html_content,
                             "<p><b>1. H·ªá s·ªë h·ªìi quy</b> cho bi·∫øn <i>", mod_name, "</i> l√† <b>", round(mod_coef, 3), "</b> ",
                             "(95% CI: ", round(mod_ci_lower, 3), " ƒë·∫øn ", round(mod_ci_upper, 3), "). ",
                             "ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† ",
                             ifelse(mod_coef > 0,
                                    paste0("khi <i>", mod_name, "</i> tƒÉng l√™n, m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa can thi·ªáp c√≥ xu h∆∞·ªõng <b>tƒÉng</b>."),
                                    paste0("khi <i>", mod_name, "</i> tƒÉng l√™n, m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa can thi·ªáp c√≥ xu h∆∞·ªõng <b>gi·∫£m</b>.")),
                             "</p>"
      )
    } else {
      html_content <- paste0(html_content,
                             "<p><b>1. H·ªá s·ªë h·ªìi quy:</b> Kh√¥ng th·ªÉ tr√≠ch xu·∫•t h·ªá s·ªë h·ªìi quy t·ª´ k·∫øt qu·∫£.</p>"
      )
    }
    
    # √ù nghƒ©a th·ªëng k√™
    if (!is.na(mod_p)) {
      html_content <- paste0(html_content,
                             "<p><b>2. √ù nghƒ©a th·ªëng k√™:</b> V·ªõi gi√° tr·ªã p = ", round(mod_p, 3), ", ",
                             ifelse(mod_p < 0.05,
                                    paste0("bi·∫øn <i>", mod_name, "</i> c√≥ <b>li√™n quan ƒë√°ng k·ªÉ</b> ƒë·∫øn m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa can thi·ªáp (p < 0.05)."),
                                    paste0("bi·∫øn <i>", mod_name, "</i> <b>kh√¥ng c√≥ li√™n quan ƒë√°ng k·ªÉ</b> ƒë·∫øn m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa can thi·ªáp (p ‚â• 0.05).")),
                             " Kho·∫£ng tin c·∫≠y 95% ",
                             ifelse(!is.na(mod_ci_lower) && !is.na(mod_ci_upper) && mod_ci_lower * mod_ci_upper <= 0,
                                    "<b>ch·ª©a gi√° tr·ªã 0</b>, x√°c nh·∫≠n th√™m r·∫±ng kh√¥ng c√≥ b·∫±ng ch·ª©ng th·ªëng k√™ v·ªÅ m·ªëi li√™n h·ªá.",
                                    "<b>kh√¥ng ch·ª©a gi√° tr·ªã 0</b>, x√°c nh·∫≠n th√™m v·ªÅ √Ω nghƒ©a th·ªëng k√™ c·ªßa m·ªëi li√™n h·ªá."
                             ),
                             "</p>"
      )
    } else {
      html_content <- paste0(html_content,
                             "<p><b>2. √ù nghƒ©a th·ªëng k√™:</b> Kh√¥ng th·ªÉ tr√≠ch xu·∫•t gi√° tr·ªã p t·ª´ k·∫øt qu·∫£.</p>"
      )
    }
    
    # R¬≤ v√† t√≠nh b·∫•t ƒë·ªìng nh·∫•t c√≤n l·∫°i - S·ª¨A L·ªñI PH·∫¶N N√ÄY
    r2_text <- ifelse(is.na(r2_value),
                      "Kh√¥ng th·ªÉ tr√≠ch xu·∫•t gi√° tr·ªã R¬≤ t·ª´ k·∫øt qu·∫£.",
                      paste0("Bi·∫øn <i>", mod_name, "</i> gi·∫£i th√≠ch <b>", round(r2_value, 1), 
                             "%</b> t√≠nh b·∫•t ƒë·ªìng nh·∫•t gi·ªØa c√°c nghi√™n c·ª©u. "))
    
    r2_interpretation <- ""
    if(!is.na(r2_value)) {
      if(r2_value < 10) {
        r2_interpretation <- "ƒê√¢y l√† t·ª∑ l·ªá <b>r·∫•t th·∫•p</b>, cho th·∫•y bi·∫øn n√†y gi·∫£i th√≠ch ƒë∆∞·ª£c r·∫•t √≠t s·ª± kh√°c bi·ªát gi·ªØa c√°c nghi√™n c·ª©u."
      } else if(r2_value < 30) {
        r2_interpretation <- "ƒê√¢y l√† t·ª∑ l·ªá <b>th·∫•p ƒë·∫øn trung b√¨nh</b>, cho th·∫•y bi·∫øn n√†y gi·∫£i th√≠ch ƒë∆∞·ª£c m·ªôt ph·∫ßn nh·ªè s·ª± kh√°c bi·ªát gi·ªØa c√°c nghi√™n c·ª©u."
      } else if(r2_value < 60) {
        r2_interpretation <- "ƒê√¢y l√† t·ª∑ l·ªá <b>trung b√¨nh ƒë·∫øn cao</b>, cho th·∫•y bi·∫øn n√†y gi·∫£i th√≠ch ƒë∆∞·ª£c m·ªôt ph·∫ßn ƒë√°ng k·ªÉ s·ª± kh√°c bi·ªát gi·ªØa c√°c nghi√™n c·ª©u."
      } else {
        r2_interpretation <- "ƒê√¢y l√† t·ª∑ l·ªá <b>r·∫•t cao</b>, cho th·∫•y bi·∫øn n√†y gi·∫£i th√≠ch ƒë∆∞·ª£c ph·∫ßn l·ªõn s·ª± kh√°c bi·ªát gi·ªØa c√°c nghi√™n c·ª©u."
      }
    }
    
    html_content <- paste0(html_content,
                           "<p><b>3. Kh·∫£ nƒÉng gi·∫£i th√≠ch t√≠nh b·∫•t ƒë·ªìng nh·∫•t (R¬≤):</b> ",
                           r2_text,
                           r2_interpretation,
                           "</p>")
    
    # T√≠nh b·∫•t ƒë·ªìng nh·∫•t tr∆∞·ªõc v√† sau
    if (!is.na(i2_before)) {
      html_content <- paste0(html_content,
                             "<p><b>4. T√≠nh b·∫•t ƒë·ªìng nh·∫•t:</b> ",
                             "I¬≤ ban ƒë·∫ßu l√† <b>", round(i2_before, 1), "%</b>"
      )
      
      if (!is.na(i2_after)) {
        html_content <- paste0(html_content,
                               " v√† I¬≤ c√≤n l·∫°i sau khi ƒë∆∞a bi·∫øn <i>", mod_name, "</i> v√†o m√¥ h√¨nh l√† <b>",
                               round(i2_after, 1), "%</b>. ",
                               ifelse(i2_before > i2_after,
                                      paste0("ƒêi·ªÅu n√†y cho th·∫•y bi·∫øn n√†y gi√∫p gi·∫£i th√≠ch ƒë∆∞·ª£c <b>", round(i2_before - i2_after, 1), 
                                             "% ƒëi·ªÉm</b> c·ªßa t√≠nh b·∫•t ƒë·ªìng nh·∫•t."),
                                      "Kh√¥ng c√≥ s·ª± gi·∫£m t√≠nh b·∫•t ƒë·ªìng nh·∫•t khi ƒë∆∞a bi·∫øn n√†y v√†o m√¥ h√¨nh."
                               )
        )
      }
      
      html_content <- paste0(html_content, "</p>")
    }
    
    # K·∫øt lu·∫≠n
    conclusion <- ""
    if(!is.na(mod_p) && !is.na(r2_value)) {
      if(mod_p < 0.05 && r2_value > 10) {
        conclusion <- paste0("Bi·∫øn <i>", mod_name, "</i> c√≥ <b>t√°c ƒë·ªông ƒë√°ng k·ªÉ</b> ƒë·∫øn m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa can thi·ªáp v√† gi·∫£i th√≠ch ƒë∆∞·ª£c m·ªôt ph·∫ßn t√≠nh b·∫•t ƒë·ªìng nh·∫•t gi·ªØa c√°c nghi√™n c·ª©u.")
      } else if(mod_p < 0.05 && r2_value <= 10) {
        conclusion <- paste0("M·∫∑c d√π bi·∫øn <i>", mod_name, "</i> c√≥ <b>li√™n quan ƒë√°ng k·ªÉ v·ªÅ m·∫∑t th·ªëng k√™</b> v·ªõi m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng, nh∆∞ng n√≥ ch·ªâ gi·∫£i th√≠ch ƒë∆∞·ª£c r·∫•t √≠t t√≠nh b·∫•t ƒë·ªìng nh·∫•t gi·ªØa c√°c nghi√™n c·ª©u.")
      } else if(mod_p >= 0.05 && r2_value > 10) {
        conclusion <- paste0("M·∫∑c d√π bi·∫øn <i>", mod_name, "</i> <b>kh√¥ng c√≥ li√™n quan ƒë√°ng k·ªÉ v·ªÅ m·∫∑t th·ªëng k√™</b>, nh∆∞ng n√≥ v·∫´n c√≥ th·ªÉ gi·∫£i th√≠ch m·ªôt ph·∫ßn s·ª± kh√°c bi·ªát gi·ªØa c√°c nghi√™n c·ª©u. N√™n th·∫≠n tr·ªçng khi di·ªÖn gi·∫£i k·∫øt qu·∫£ n√†y.")
      } else {
        conclusion <- paste0("Bi·∫øn <i>", mod_name, "</i> <b>kh√¥ng c√≥ li√™n quan ƒë√°ng k·ªÉ</b> ƒë·∫øn m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng c·ªßa can thi·ªáp v√† gi·∫£i th√≠ch ƒë∆∞·ª£c r·∫•t √≠t t√≠nh b·∫•t ƒë·ªìng nh·∫•t gi·ªØa c√°c nghi√™n c·ª©u.")
      }
    } else {
      conclusion <- "Kh√¥ng ƒë·ªß th√¥ng tin ƒë·ªÉ ƒë∆∞a ra k·∫øt lu·∫≠n v·ªÅ m·ªëi li√™n h·ªá gi·ªØa bi·∫øn v√† m·ª©c ƒë·ªô ·∫£nh h∆∞·ªüng."
    }
    
    html_content <- paste0(html_content,
                           "<p><b>5. K·∫øt lu·∫≠n:</b> ",
                           conclusion,
                           "</p>",
                           "<p><i>L∆∞u √Ω: Ph√¢n t√≠ch g·ªôp h·ªìi quy ch·ªâ thi·∫øt l·∫≠p m·ªëi li√™n quan, kh√¥ng ch·ª©ng minh quan h·ªá nh√¢n qu·∫£. K·∫øt qu·∫£ c·∫ßn ƒë∆∞·ª£c di·ªÖn gi·∫£i trong b·ªëi c·∫£nh l√¢m s√†ng v√† √Ω nghƒ©a th·ª±c ti·ªÖn.</i></p>",
                           "</div>")
    
    return(html_content)
  }
  
  # Display results
  output$ma_summary <- renderPrint({
    res <- meta_result()
    if (inherits(res, "error")) {
      cat("L·ªói ph√¢n t√≠ch ho·∫∑c thi·∫øu d·ªØ li·ªáu:", res$error)
    } else {
      print(res)
    }
  })
  
  # Generate interpretation of meta-analysis results
  output$ma_results_interpretation_actual <- renderUI({
    res <- meta_result()
    HTML(generate_ma_interpretation(res))
  })
  
  # Forest plot
  output$ma_forest <- renderPlot({
    res <- meta_result()
    if (!inherits(res, "error") && inherits(res, "meta")) {
      meta::forest(res, main = "Bi·ªÉu ƒë·ªì r·ª´ng (forest plot)")
    }
  })
  
  # Generate forest plot interpretation
  output$ma_forest_interpretation_actual <- renderUI({
    res <- meta_result()
    HTML(generate_forest_interpretation(res))
  })
  
  # Funnel plot
  output$ma_funnel <- renderPlot({
    res <- meta_result()
    if (!inherits(res, "error") && inherits(res, "meta")) {
      meta::funnel(res, main = "Bi·ªÉu ƒë·ªì ph·ªÖu (funnel plot)")
    }
  })
  
  # Egger test result
  egger_result <- reactive({
    res <- meta_result()
    if (!inherits(res, "error") && inherits(res, "meta")) {
      tryCatch({
        egger <- meta::metabias(res, method.bias = "linreg")
        return(egger)
      }, error = function(e) NULL)
    } else {
      return(NULL)
    }
  })
  
  # Egger test
  output$ma_egger <- renderPrint({
    res <- meta_result()
    if (!inherits(res, "error") && inherits(res, "meta")) {
      cat("Ki·ªÉm ƒë·ªãnh Egger cho sai l·ªách c√¥ng b·ªë:\n")
      egger_res <- tryCatch(meta::metabias(res, method.bias="linreg"), error=function(e) e)
      if (inherits(egger_res, "error")) {
        cat("Kh√¥ng th·ªÉ th·ª±c hi·ªán ki·ªÉm ƒë·ªãnh Egger. L·ªói:", egger_res$message)
      } else {
        print(egger_res)
      }
    }
  })
  
  # Trim-and-fill plot
  output$ma_trimfill <- renderPlot({
    res <- meta_result()
    if (!inherits(res, "error") && inherits(res, "meta")) {
      tf <- tryCatch(meta::trimfill(res), error=function(e) NULL)
      if (!is.null(tf)) meta::funnel(tf, main = "Bi·ªÉu ƒë·ªì ph·ªÖu hi·ªáu ch·ªânh (trim-and-fill funnel plot)")
    }
  })
  
  # Generate publication bias interpretation
  output$ma_bias_interpretation_actual <- renderUI({
    res <- meta_result()
    egger <- egger_result()
    HTML(generate_bias_interpretation(res, egger))
  })
  
  # ----- META-REGRESSION -----
  output$ma_metareg_var_selector <- renderUI({
    df <- ma_data()
    
    # Ki·ªÉm tra xem c√≥ c·ªôt RegVar kh√¥ng
    if ("RegVar" %in% names(df)) {
      # Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu RegVar kh√¥ng NA kh√¥ng
      if (any(!is.na(df$RegVar))) {
        selectInput("ma_metareg_var", "Ch·ªçn bi·∫øn cho ph√¢n t√≠ch h·ªìi quy:", 
                    choices = c("RegVar"), 
                    selected = "RegVar")
      } else {
        HTML("<div class='alert alert-warning'>Kh√¥ng c√≥ d·ªØ li·ªáu trong bi·∫øn RegVar. Vui l√≤ng nh·∫≠p d·ªØ li·ªáu v√†o c·ªôt RegVar.</div>")
      }
    } else {
      HTML("<div class='alert alert-warning'>Kh√¥ng c√≥ bi·∫øn RegVar trong d·ªØ li·ªáu. Vui l√≤ng s·ª≠ d·ª•ng c·∫•u tr√∫c d·ªØ li·ªáu c√≥ ch·ª©a c·ªôt RegVar.</div>")
    }
  })
  
  ma_metareg_result <- eventReactive(input$ma_run_metareg, {
    ma_res <- meta_result()
    
    if(inherits(ma_res, "error")) {
      return(structure(list(error="C·∫ßn ch·∫°y ph√¢n t√≠ch g·ªôp tr∆∞·ªõc!"), class="error"))
    }
    
    df <- ma_data()
    
    # L·ªçc c√°c d√≤ng thi·∫øu d·ªØ li·ªáu c·∫ßn thi·∫øt
    df <- df[!is.na(df$RegVar), ]
    
    if (!input$ma_do_metareg || is.null(input$ma_metareg_var)) {
      return(structure(list(error="Vui l√≤ng ch·ªçn bi·∫øn cho ph√¢n t√≠ch h·ªìi quy"), class="error"))
    }
    
    if (nrow(df) < 3) {
      return(structure(list(error="C·∫ßn √≠t nh·∫•t 3 nghi√™n c·ª©u c√≥ d·ªØ li·ªáu RegVar ƒë·ªÉ th·ª±c hi·ªán ph√¢n t√≠ch h·ªìi quy"), class="error"))
    }
    
    # Ki·ªÉm tra xem bi·∫øn ƒë√£ ch·ªçn c√≥ t·ªìn t·∫°i kh√¥ng
    if (!input$ma_metareg_var %in% names(df)) {
      return(structure(list(error=paste("Bi·∫øn", input$ma_metareg_var, "kh√¥ng t·ªìn t·∫°i trong d·ªØ li·ªáu")), class="error"))
    }
    
    # Th·ª±c hi·ªán meta-regression v·ªõi c√°c nghi√™n c·ª©u c√≥ d·ªØ li·ªáu RegVar
    tryCatch({
      mr <- meta::metareg(ma_res, formula = as.formula(paste("~", input$ma_metareg_var)))
      return(mr)
    }, error = function(e) {
      return(structure(list(error=paste("L·ªói ph√¢n t√≠ch h·ªìi quy:", e$message)), class="error"))
    })
  })
  
  output$ma_metareg_result <- renderPrint({
    res <- ma_metareg_result()
    if (inherits(res, "error")) {
      cat("L·ªói ph√¢n t√≠ch g·ªôp h·ªìi quy:", res$error)
    } else {
      print(res)
    }
  })
  
  output$ma_metareg_plot <- renderPlot({
    res <- ma_metareg_result()
    if (!inherits(res, "error") && inherits(res, "metareg")) {
      meta::bubble(res, studlab = TRUE, main = "Bi·ªÉu ƒë·ªì n·ªïi b·ªçt ph√¢n t√≠ch g·ªôp h·ªìi quy")
    }
  })
  
  # Generate meta-regression interpretation
  output$ma_metareg_interpretation_actual <- renderUI({
    mr_result <- ma_metareg_result()
    if (!is.null(mr_result) && !inherits(mr_result, "try-error")) {
      tryCatch({
        HTML(generate_metareg_interpretation(mr_result))
      }, error = function(e) {
        HTML(paste0("<div class='alert alert-danger'>L·ªói khi bi·ªán gi·∫£i: ", e$message, 
                    ". Vui l√≤ng ki·ªÉm tra l·∫°i d·ªØ li·ªáu.</div>"))
      })
    } else {
      HTML("<div class='alert alert-danger'>Kh√¥ng th·ªÉ t·∫°o bi·ªán gi·∫£i ƒë·∫ßy ƒë·ªß cho k·∫øt qu·∫£ ph√¢n t√≠ch g·ªôp h·ªìi quy. C√≥ th·ªÉ do d·ªØ li·ªáu kh√¥ng ƒë·ªß ho·∫∑c c·∫•u tr√∫c kh√¥ng ph√π h·ª£p.</div>")
    }
  })
  
  # Tr·∫£ v·ªÅ c√°c reactive values ƒë·ªÉ c√≥ th·ªÉ d√πng ·ªü n∆°i kh√°c n·∫øu c·∫ßn
  return(list(
    ma_data = ma_data,
    meta_result = meta_result,
    ma_metareg_result = ma_metareg_result
  ))
}